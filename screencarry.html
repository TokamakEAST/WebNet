<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>屏幕捕捉和区域选择</title>
    <style>
        #previewCanvas {
            border: 1px solid black;
            width: 640px; /* 设置预览画面的尺寸 */
            height: 360px;
        }
        #displayCanvas {
            border: 1px solid red;
            width: 320px; /* 设置显示框的尺寸 */
            height: 180px;
        }
        #selection {
            border: 2px dashed blue;
            position: absolute;
            display: none;
        }
        #container {
            position: relative;
        }
    </style>
</head>
<body>
    <h2>捕捉屏幕并选择区域显示</h2>
    <button onclick="startCapture()">开始捕捉屏幕</button>
    <div id="container" style="width: 640px; height: 360px;">
        <canvas id="previewCanvas"></canvas>
        <div id="selection"></div>
    </div>
    <canvas id="displayCanvas"></canvas>

    <script>
        let video = document.createElement('video');
        video.autoplay = true;
        video.style.display = 'none';
        document.body.appendChild(video);

        let container = document.getElementById('container');
        let previewCanvas = document.getElementById('previewCanvas');
        let displayCanvas = document.getElementById('displayCanvas');
        let selection = document.getElementById('selection');
        let previewContext = previewCanvas.getContext('2d');
        let displayContext = displayCanvas.getContext('2d');
        let startX, startY, drag = false;

        async function startCapture() {
            try {
                video.srcObject = await navigator.mediaDevices.getDisplayMedia({video: { cursor: "always" }});
                video.onloadedmetadata = () => {
                    previewCanvas.width = video.videoWidth;
                    previewCanvas.height = video.videoHeight;
                    displayCanvas.width = 320;  // 可调整为需要的尺寸
                    displayCanvas.height = 180;  // 可调整为需要的尺寸
                    drawCanvas();
                };
            } catch (err) {
                console.error('Error: ' + err);
            }
        }

        function drawCanvas() {
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                previewContext.drawImage(video, 0, 0, previewCanvas.width, previewCanvas.height);
                if (drag) {
                    displaySelectedArea();
                }
                requestAnimationFrame(drawCanvas);
            }
        }

        container.addEventListener('mousedown', function(e) {
            startX = e.offsetX;
            startY = e.offsetY;
            selection.style.left = startX + 'px';
            selection.style.top = startY + 'px';
            selection.style.width = '0px';
            selection.style.height = '0px';
            selection.style.display = 'block';
            drag = true;
        });

        container.addEventListener('mousemove', function(e) {
            if (drag) {
                let currentX = e.offsetX;
                let currentY = e.offsetY;
                let width = Math.abs(currentX - startX);
                let height = Math.abs(currentY - startY);
                selection.style.width = width + 'px';
                selection.style.height = height + 'px';
                selection.style.left = Math.min(startX, currentX) + 'px';
                selection.style.top = Math.min(startY, currentY) + 'px';
            }
        });

        container.addEventListener('mouseup', function() {
            drag = false;
        });

        function displaySelectedArea() {
            let rect = selection.getBoundingClientRect();
            let scaleX = video.videoWidth / previewCanvas.offsetWidth;
            let scaleY = video.videoHeight / previewCanvas.offsetHeight;
            let x = (rect.left - previewCanvas.offsetLeft) * scaleX;
            let y = (rect.top - previewCanvas.offsetTop) * scaleY;
            let width = rect.width * scaleX;
            let height = rect.height * scaleY;
            displayContext.drawImage(video, x, y, width, height, 0, 0, displayCanvas.width, displayCanvas.height);
        }
    </script>
</body>
</html>
